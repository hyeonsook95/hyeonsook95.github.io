---
layout: post
title: "Celery tasks 구조 변경하기"
date: 2021-06-01
tag:
 - celery
 - django
 - python
---

앱의 로그인이 잘 되지 않는다는 사용자분들의 요청이 있었다. 여러 원인이 있겠지만, 내 디바이스에서도 로그인을 시도한 후에 화면이 바뀌지 않는 문제점이 있었다. 앱을 삭제하고 다시 설치하는 과정을 반복하면서 나중에는 그런 일이 없었기 때문에 대수롭지 않게 넘어갔건만..

## 문제 분석

내 디바이스에서 로그인이 안되는 과정은 아래와 같았다.

1. 로그인 시도 완료함.
2. 화면이 변경되지 않음.
3. 2일 뒤에 앱에 접속하자 화면이 바뀌어 있었음.

앱의 로직은 아래와 같았다.

1. 앱에서 카카오에게 소셜 로그인 요청을 보낸다.
2. 카카오에게 요청과 이메일 값을 받아 서버로 보낸다.
3. 서버에서 토큰을 받아와 디바이스에 저장한다.
4. 토큰이 있을 경우, 앱의 화면이 바뀐다.

여기서 추론한 문제점은 **서버에서 로그인을 처리하는 프로세스가 늦게 응답했구나!** 라는 거였다. 카카오 로그인을 요청해놓은 뒤에 아무런 작동도 하지 않았는데, 로그인이 되었다는 건 토큰 값을 받아오는 게 느렸을 것이다라고 생각했기 때문이다.

확인을 위해 서버 상태를 확인하였다.

```bash
$ top
... load average: 4.xx 4.xx, 4.xx

... celery
... celery
... celery
```

서버 상태를 확인하자 `load average` 가 4 4 4 였다. 우리 서버의 코어는 2인데 말이다. 거기다 cpu를 사용하는 프로세스의 1, 2, 3위가 모두 샐러리 데몬이었다.

거기다 celery 가 한 번 멈춘적도 있었으니, celery 구조를 다시 설계해야겠다는 생각이 들었다.

## Celery 분석

